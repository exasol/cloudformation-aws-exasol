{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "Exasol Database",
	"Metadata": {
		"Images": {"regions":{"ap-east-1":{"RegionKey":"apeast1"},"ap-northeast-1":{"RegionKey":"apnortheast1"},"ap-northeast-2":{"RegionKey":"apnortheast2"},"ap-south-1":{"RegionKey":"apsouth1"},"ap-southeast-1":{"RegionKey":"apsoutheast1"},"ap-southeast-2":{"RegionKey":"apsoutheast2"},"ca-central-1":{"RegionKey":"cacentral1"},"eu-central-1":{"RegionKey":"eucentral1"},"eu-west-1":{"RegionKey":"euwest1"},"eu-west-2":{"RegionKey":"euwest2"},"eu-west-3":{"RegionKey":"euwest3"},"me-south-1":{"RegionKey":"mesouth1"},"sa-east-1":{"RegionKey":"saeast1"},"us-east-1":{"RegionKey":"useast1"},"us-east-2":{"RegionKey":"useast2"},"us-west-1":{"RegionKey":"uswest1"},"us-west-2":{"RegionKey":"uswest2"},"eu-north-1":{"RegionKey":"eunorth1"},"eu-south-1":{"RegionKey":"eusouth1"},"af-south-1":{"RegionKey":"afsouth1"}},"apeast1":{"EXASOL-7.0.4-BYOL":{"AMI":""},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0fe6ac8f1a434554f"}},"apnortheast1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0f41c379273279b73"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0e396e2effcbe7c50"}},"apnortheast2":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-01cbcf44b98407da6"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0c141ea20c7320f43"}},"apsouth1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0fedd05e0e4ed9efb"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-065630142463d4637"}},"apsoutheast1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0346922c19230ab6e"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0a8702683a03f4948"}},"apsoutheast2":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-01b0b46c5032bcdde"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-08292dff37a7fed05"}},"cacentral1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-025553e29e85303da"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0ce7764bc3ba8ec5d"}},"eucentral1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0887c3cfe5f3ef8af"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-010f6aebada0a39b8"}},"euwest1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-06a3ca6f58c324fc6"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-01f6f08d3bee76b51"}},"euwest2":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-02bbc7b8b4cc25be7"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0a44efe1bf25e9806"}},"euwest3":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0956a04135553ca22"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0cfd79ec23f49bf8f"}},"mesouth1":{"EXASOL-7.0.4-BYOL":{"AMI":""},"EXASOL-7.0.4-PAYG":{"AMI":"ami-096783aa43e8be6f2"}},"saeast1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0d6d925b8c64916c9"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0f54d19824493c39aZ"}},"useast1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0570a6da74bc80152"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-04e143db51df28f5f"}},"useast2":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0880392e454c6a72e"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-08fe3e1063d022fa0"}},"uswest1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0876dfaa96e7328c0"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0873f535b8b78d978"}},"uswest2":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0d4b6775dab81b49f"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-06916a9aacb723fa0"}},"eunorth1":{"EXASOL-7.0.4-BYOL":{"AMI":"ami-0bcc48bf0f356572b"},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0949ba7ef49932824"}},"eusouth1":{"EXASOL-7.0.4-BYOL":{"AMI":""},"EXASOL-7.0.4-PAYG":{"AMI":"ami-0b84dd5cfac8ecd94"}},"afsouth1":{"EXASOL-7.0.4-BYOL":{"AMI":""},"EXASOL-7.0.4-PAYG":{"AMI":"ami-045ff9bd55c0cc234"}}},
						
		"AWS::CloudFormation::Interface": {
			"ParameterGroups": [
				{
					"Label": {
						"default": "Key Pair"
					},
					"Parameters": [
						"KeyName"
					]
				},				
				{
					"Label": {
						"default": "Default Tags"
					},
					"Parameters": [
						"ProjectTag",
						"OwnerTag"
					]
				},
								
				{
					"Label": {
						"default": "Exasol Database"
					},
					"Parameters": [
						"DBSystemName",
						"DBPassword",
						"ExasolPassword"
					]
				},{
					"Label": {
						"default": "VPC/Network/Security"
					},
					"Parameters": [
                        
                        "SubnetId",
                        
                        "PublicIP",
						"CreateS3Bucket",
						"CreateS3Endpoint",
						"CreateKMSEndpoint",
											
						"DNSServer",
                        "NTPServer",
                        "Timezone",
						"SecurityGroupAccess",
						"OpenPorts"						
					]
				},
				{
					"Label": {
						"default": "Node Configuration"
					},
					"Parameters": [
						"DatabaseNodeInstanceType",
						"ImageId"
					]
				},
				{
					"Label": {
						"default": "Data Volume(s) Configuration"
					},
					"Parameters": [
						"DBEBSEncryption"
						,"BlockDeviceVolumeSize",
						"BlockDeviceCount"
					]
				},
				{
					"Label": {
						"default": "License"
					},
					"Parameters": [
						"License"
					]
				}
			],
			"ParameterLabels": {
				"ProjectTag": {
					"default": "exa:project"
				},
				"OwnerTag": {
					"default": "exa:owner"
				},				
								
				"DBSystemName": {
					"default": "Database Name"
				},
                "DBPassword": {
					"default": "SYS User Password"
				},
				"ExasolPassword": {
					"default": "ADMIN User Password"
				},
				"KeyName": {
					"default": "AWS Key Pair"
				},
                "License": {
                    "default": "License (OPTIONAL)"
                },
                "PublicIP": {
                    "default": "Public IPs"
                },
				"CreateS3Endpoint": {
					"default": "Create S3 endpoint"
				},
				"CreateKMSEndpoint": {
					"default": "Create KMS endpoint"
				},
							
				
                
                "SubnetId":{"default":"Database Subnet-Id"},
				"SecurityGroupAccess": {
					"default": "Remote Access from distinct IP address ranges"
				},
				"OpenPorts": {
					"default": "Remote Access from defined Ports"
				},				
				"ImageId": {
					"default": "AMI ID"
				},
				"DatabaseNodeInstanceType": {
					"default": "Instance Type"
				},
				"DNSServer": {
                    "default": "DNS Server"
				},
				"NTPServer": {
                    "default": "NTP Server"
				},
                "Timezone": {
                    "default": "System Timezone"
                },
				"DBEBSEncryption":{
                    "default": "Encrypt EBS volumes"
				}
				,"BlockDeviceVolumeSize":{
                    "default": "Size in GB of Data Block Device Volumes"
				},
				"BlockDeviceCount":{
                    "default": "Number of Data Block Device Volumes per Node"
				}
			}
		}
	},
	"Parameters": {
		"ProjectTag": {
			"Description": "Tag exa:project for Resource Group arrangement",
			"Type": "String",
			"Default": "exasol"
		},
		"OwnerTag": {
			"Description": "Tag exa:owner for Resource Group arrangement",
			"Type": "String",
			"Default": "user@example.com"
		},		
					
		"DatabaseNodeInstanceType": {
			"AllowedValues": [
                
                "m4.large","m4.xlarge","m4.2xlarge","m4.4xlarge","m4.10xlarge","m4.16xlarge","m5.large","m5.xlarge","m5.2xlarge","m5.4xlarge","m5.8xlarge","m5.12xlarge","m5.16xlarge","m5.24xlarge","m5a.large","m5a.xlarge","m5a.2xlarge","m5a.4xlarge","m5a.8xlarge","m5a.12xlarge","m5a.16xlarge","m5a.24xlarge","m5d.large","m5d.xlarge","m5d.2xlarge","m5d.4xlarge","m5d.8xlarge","m5d.12xlarge","m5d.16xlarge","m5d.24xlarge","c4.large","c4.xlarge","c4.2xlarge","c4.4xlarge","c4.8xlarge","c5.large","c5.xlarge","c5.2xlarge","c5.4xlarge","c5.9xlarge","c5.12xlarge","c5.18xlarge","c5.24xlarge","c5d.large","c5d.xlarge","c5d.2xlarge","c5d.4xlarge","c5d.9xlarge","c5d.12xlarge","c5d.18xlarge","r3.large","r3.xlarge","r3.2xlarge","r3.4xlarge","r3.8xlarge","r4.large","r4.xlarge","r4.2xlarge","r4.4xlarge","r4.8xlarge","r4.16xlarge","r5.large","r5.xlarge","r5.2xlarge","r5.4xlarge","r5.8xlarge","r5.12xlarge","r5.16xlarge","r5.24xlarge","r5a.large","r5a.xlarge","r5a.2xlarge","r5a.4xlarge","r5a.8xlarge","r5a.12xlarge","r5a.16xlarge","r5a.24xlarge","r5d.large","r5d.xlarge","r5d.2xlarge","r5d.4xlarge","r5d.8xlarge","r5d.12xlarge","r5d.16xlarge","r5d.24xlarge"
			],
            
            "Default": "m5.4xlarge",
			"Description": "Recommended instance types",
			"Type": "String"
		},
        "PublicIP": {
			"AllowedValues": [
				"true",
				"false"
			],
			"Default": "false",
			"Description": "Associate public ip addresses to all instances",
			"Type": "String"
		},
        "CreateS3Bucket": {
			"AllowedValues": [
				"true",
				"false"
			],
			"Default": "true",
			"Description": "Create s3 bucket for a default backup location",
			"Type": "String"
		},
        "CreateS3Endpoint": {
			"AllowedValues": [
				"true",
				"false"
			],
			"Default": "true",
			"Description": "Set to false if instance is public available or if s3 endpoint already exist",
			"Type": "String"
		},
        "CreateKMSEndpoint": {
			"AllowedValues": [
				"true",
				"false"
			],
			"Default": "true",
			"Description": "Set to false if instance is public available or if kms endpoint already exists",
			"Type": "String"
		},
			
        "DBEBSEncryption": {
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "true",
            "Description": "Encrypt attached EBS volumes",
            "Type": "String"
        },
		"DBSystemName": {
            "Default": "exasol",
			"AllowedPattern": "[a-zA-Z0-9_]{5,20}",
			"ConstraintDescription": "must only contain 5-20 alphanumeric characters and the underline character",
			"Description": "(Format: only lower case, upper case, underline character, 5-20 length)",
			"MaxLength": "20",
			"MinLength": "5",
			"Type": "String"
		},
		"ExasolPassword": {
			"Description": "Password for the EXAoperation system administration user ADMIN (Format: lower case, upper case, digit, 8-20 length)",
			"MinLength": "8",
            "MaxLength" : "20",
			"NoEcho": true,
			"Type": "String",
            "AllowedPattern" : "^(?=.*\\d)(?=.*[a-z])(?=.*[A-Z])(?!.*\\s).{8,}$",
            "ConstraintDescription": "requires one lower case letter, one upper case letter, one digit, 8-20 length, and no spaces"
		},        
		"DBPassword": {
			"Description": "Password for the database administration user SYS (Format: lower case, upper case, digit, 8-20 length)",
			"MinLength": "8",
            "MaxLength" : "20",
			"NoEcho": true,
			"Type": "String",
            "AllowedPattern" : "^(?=.*\\d)(?=.*[a-z])(?=.*[A-Z])(?!.*\\s).{8,}$",
            "ConstraintDescription": "requires one lower case letter, one upper case letter, one digit, 8-20 length, and no spaces"
		},
		"KeyName": {
			"Description": "",
			"Type": "AWS::EC2::KeyPair::KeyName",
			"MinLength": "1"
		},
        "License": {
			"Default": "",
			"Description": "In case of a BYOL image, an already aquired license can be pasted here",
			"Type": "String"
        },
		"SecurityGroupAccess": {
			"Default": "0.0.0.0/0",
			"AllowedPattern": "\\d{1,3}([.]\\d{1,3}){3}/\\d{1,2}",
			"ConstraintDescription": "Must be valid comma separated CIDR blocks, e.g. 0.0.0.0/0 default route -> allow access from everywhere or 192.168.0.0/24,10.0.0.0/24 to restrict access to specific ip ranges.",
			"Description": "Must be valid comma separated CIDR blocks, e.g. 0.0.0.0/0 default route -> allow access from everywhere or 192.168.0.0/24,10.0.0.0/24 to restrict access to specific ip ranges.",
			"Type": "List<String>"
		},
		"OpenPorts": {
			"Default": "20,22,443,6583,8563,8835",
			"AllowedPattern": "\\d{1,5}([-]\\d{1,5}){0,1}",
			"ConstraintDescription": "Must be a valid notation of comma separated ports or port ranges (e.g. 2000-3000), default ports are: 22 SSH, 443 EXAOperation, 6583 BucketFS, 8563 Exasol Database, 8835 CloudUI.",
			"Description": "Must be a valid notation of comma separated ports or port ranges (e.g. 2000-3000), default ports are: 22 SSH, 443 EXAOperation, 6583 BucketFS, 8563 Exasol Database, 8835 CloudUI.",
			"Type": "List<String>"
		},				
        
        "SubnetId":{"Type":"AWS::EC2::Subnet::Id", "MinLength": "1"},
        
		
        "ImageId":{"Type":"String","Description": "Amazon Machine Image ID", "AllowedPattern": "(?i)\\b[a-z]+-[a-z0-9]+", "ConstraintDescription": "must correspond to valid AMI ID"},
		"BlockDeviceVolumeSize": {
			"Default": "334",
			"Description": "Size in GB per block device volume (for optimal performance >= 334GB)",
			"MaxValue": 16000,
			"Type": "Number"
		},
		"BlockDeviceCount": {
			"Default": "4",
			"MaxValue": 16,
			"MinValue": 1,
			"Type": "Number"
		},
		"DNSServer":{
            "Default":"169.254.169.253",
            "Type":"String",
            "Description": "Default Amazon DNS Server"
		},
		"NTPServer":{
            "Default":" 169.254.169.123",
            "Type":"String",
            "Description": "Default Amazon NTP Server"
		},
        "Timezone": {
            "AllowedValues": [
                "", "Africa/Abidjan", "Africa/Accra", "Africa/Addis_Ababa", "Africa/Algiers", "Africa/Asmara", "Africa/Asmera", "Africa/Bamako", "Africa/Bangui", "Africa/Banjul", "Africa/Bissau", "Africa/Blantyre", "Africa/Brazzaville", "Africa/Bujumbura", "Africa/Cairo", "Africa/Casablanca", "Africa/Ceuta", "Africa/Conakry", "Africa/Dakar", "Africa/Dar_es_Salaam", "Africa/Djibouti", "Africa/Douala", "Africa/El_Aaiun", "Africa/Freetown", "Africa/Gaborone", "Africa/Harare", "Africa/Johannesburg", "Africa/Juba", "Africa/Kampala", "Africa/Khartoum", "Africa/Kigali", "Africa/Kinshasa", "Africa/Lagos", "Africa/Libreville", "Africa/Lome", "Africa/Luanda", "Africa/Lubumbashi", "Africa/Lusaka", "Africa/Malabo", "Africa/Maputo", "Africa/Maseru", "Africa/Mbabane", "Africa/Mogadishu", "Africa/Monrovia", "Africa/Nairobi", "Africa/Ndjamena", "Africa/Niamey", "Africa/Nouakchott", "Africa/Ouagadougou", "Africa/Porto-Novo", "Africa/Sao_Tome", "Africa/Timbuktu", "Africa/Tripoli", "Africa/Tunis", "Africa/Windhoek", "America/Adak", "America/Anchorage", "America/Anguilla", "America/Antigua", "America/Araguaina", "America/Argentina/Buenos_Aires", "America/Argentina/Catamarca", "America/Argentina/ComodRivadavia", "America/Argentina/Cordoba", "America/Argentina/Jujuy", "America/Argentina/La_Rioja", "America/Argentina/Mendoza", "America/Argentina/Rio_Gallegos", "America/Argentina/Salta", "America/Argentina/San_Juan", "America/Argentina/San_Luis", "America/Argentina/Tucuman", "America/Argentina/Ushuaia", "America/Aruba", "America/Asuncion", "America/Atikokan", "America/Atka", "America/Bahia", "America/Bahia_Banderas", "America/Barbados", "America/Belem", "America/Belize", "America/Blanc-Sablon", "America/Boa_Vista", "America/Bogota", "America/Boise", "America/Buenos_Aires", "America/Cambridge_Bay", "America/Campo_Grande", "America/Cancun", "America/Caracas", "America/Catamarca", "America/Cayenne", "America/Cayman", "America/Chicago", "America/Chihuahua", "America/Coral_Harbour", "America/Cordoba", "America/Costa_Rica", "America/Creston", "America/Cuiaba", "America/Curacao", "America/Danmarkshavn", "America/Dawson", "America/Dawson_Creek", "America/Denver", "America/Detroit", "America/Dominica", "America/Edmonton", "America/Eirunepe", "America/El_Salvador", "America/Ensenada", "America/Fortaleza", "America/Fort_Nelson", "America/Fort_Wayne", "America/Glace_Bay", "America/Godthab", "America/Goose_Bay", "America/Grand_Turk", "America/Grenada", "America/Guadeloupe", "America/Guatemala", "America/Guayaquil", "America/Guyana", "America/Halifax", "America/Havana", "America/Hermosillo", "America/Indiana/Indianapolis", "America/Indiana/Knox", "America/Indiana/Marengo", "America/Indiana/Petersburg", "America/Indianapolis", "America/Indiana/Tell_City", "America/Indiana/Vevay", "America/Indiana/Vincennes", "America/Indiana/Winamac", "America/Inuvik", "America/Iqaluit", "America/Jamaica", "America/Jujuy", "America/Juneau", "America/Kentucky/Louisville", "America/Kentucky/Monticello", "America/Knox_IN", "America/Kralendijk", "America/La_Paz", "America/Lima", "America/Los_Angeles", "America/Louisville", "America/Lower_Princes", "America/Maceio", "America/Managua", "America/Manaus", "America/Marigot", "America/Martinique", "America/Matamoros", "America/Mazatlan", "America/Mendoza", "America/Menominee", "America/Merida", "America/Metlakatla", "America/Mexico_City", "America/Miquelon", "America/Moncton", "America/Monterrey", "America/Montevideo", "America/Montreal", "America/Montserrat", "America/Nassau", "America/New_York", "America/Nipigon", "America/Nome", "America/Noronha", "America/North_Dakota/Beulah", "America/North_Dakota/Center", "America/North_Dakota/New_Salem", "America/Ojinaga", "America/Panama", "America/Pangnirtung", "America/Paramaribo", "America/Phoenix", "America/Port-au-Prince", "America/Porto_Acre", "America/Port_of_Spain", "America/Porto_Velho", "America/Puerto_Rico", "America/Rainy_River", "America/Rankin_Inlet", "America/Recife", "America/Regina", "America/Resolute", "America/Rio_Branco", "America/Rosario", "America/Santa_Isabel", "America/Santarem", "America/Santiago", "America/Santo_Domingo", "America/Sao_Paulo", "America/Scoresbysund", "America/Shiprock", "America/Sitka", "America/St_Barthelemy", "America/St_Johns", "America/St_Kitts", "America/St_Lucia", "America/St_Thomas", "America/St_Vincent", "America/Swift_Current", "America/Tegucigalpa", "America/Thule", "America/Thunder_Bay", "America/Tijuana", "America/Toronto", "America/Tortola", "America/Vancouver", "America/Virgin", "America/Whitehorse", "America/Winnipeg", "America/Yakutat", "America/Yellowknife", "Antarctica/Casey", "Antarctica/Davis", "Antarctica/DumontDUrville", "Antarctica/Macquarie", "Antarctica/Mawson", "Antarctica/McMurdo", "Antarctica/Palmer", "Antarctica/Rothera", "Antarctica/South_Pole", "Antarctica/Syowa", "Antarctica/Troll", "Antarctica/Vostok", "Arctic/Longyearbyen", "Asia/Aden", "Asia/Almaty", "Asia/Amman", "Asia/Anadyr", "Asia/Aqtau", "Asia/Aqtobe", "Asia/Ashgabat", "Asia/Ashkhabad", "Asia/Baghdad", "Asia/Bahrain", "Asia/Baku", "Asia/Bangkok", "Asia/Beijing", "Asia/Beirut", "Asia/Bishkek", "Asia/Brunei", "Asia/Calcutta", "Asia/Chita", "Asia/Choibalsan", "Asia/Chongqing", "Asia/Chungking", "Asia/Colombo", "Asia/Dacca", "Asia/Damascus", "Asia/Dhaka", "Asia/Dili", "Asia/Dubai", "Asia/Dushanbe", "Asia/Gaza", "Asia/Harbin", "Asia/Hebron", "Asia/Ho_Chi_Minh", "Asia/Hong_Kong", "Asia/Hovd", "Asia/Irkutsk", "Asia/Istanbul", "Asia/Jakarta", "Asia/Jayapura", "Asia/Jerusalem", "Asia/Kabul", "Asia/Kamchatka", "Asia/Karachi", "Asia/Kashgar", "Asia/Kathmandu", "Asia/Katmandu", "Asia/Khandyga", "Asia/Kolkata", "Asia/Krasnoyarsk", "Asia/Kuala_Lumpur", "Asia/Kuching", "Asia/Kuwait", "Asia/Macao", "Asia/Macau", "Asia/Magadan", "Asia/Makassar", "Asia/Manila", "Asia/Muscat", "Asia/Nicosia", "Asia/Novokuznetsk", "Asia/Novosibirsk", "Asia/Omsk", "Asia/Oral", "Asia/Phnom_Penh", "Asia/Pontianak", "Asia/Pyongyang", "Asia/Qatar", "Asia/Qyzylorda", "Asia/Rangoon", "Asia/Riyadh", "Asia/Saigon", "Asia/Sakhalin", "Asia/Samarkand", "Asia/Seoul", "Asia/Shanghai", "Asia/Singapore", "Asia/Srednekolymsk", "Asia/Taipei", "Asia/Tashkent", "Asia/Tbilisi", "Asia/Tehran", "Asia/Tel_Aviv", "Asia/Thimbu", "Asia/Thimphu", "Asia/Tokyo", "Asia/Ujung_Pandang", "Asia/Ulaanbaatar", "Asia/Ulan_Bator", "Asia/Urumqi", "Asia/Ust-Nera", "Asia/Vientiane", "Asia/Vladivostok", "Asia/Yakutsk", "Asia/Yekaterinburg", "Asia/Yerevan", "Atlantic/Azores", "Atlantic/Bermuda", "Atlantic/Canary", "Atlantic/Cape_Verde", "Atlantic/Faeroe", "Atlantic/Faroe", "Atlantic/Jan_Mayen", "Atlantic/Madeira", "Atlantic/Reykjavik", "Atlantic/South_Georgia", "Atlantic/Stanley", "Atlantic/St_Helena", "Australia/ACT", "Australia/Adelaide", "Australia/Brisbane", "Australia/Broken_Hill", "Australia/Canberra", "Australia/Currie", "Australia/Darwin", "Australia/Eucla", "Australia/Hobart", "Australia/LHI", "Australia/Lindeman", "Australia/Lord_Howe", "Australia/Melbourne", "Australia/North", "Australia/NSW", "Australia/Perth", "Australia/Queensland", "Australia/South", "Australia/Sydney", "Australia/Tasmania", "Australia/Victoria", "Australia/West", "Australia/Yancowinna", "Brazil/Acre", "Brazil/DeNoronha", "Brazil/East", "Brazil/West", "Canada/Atlantic", "Canada/Central", "Canada/Eastern", "Canada/East-Saskatchewan", "Canada/Mountain", "Canada/Newfoundland", "Canada/Pacific", "Canada/Saskatchewan", "Canada/Yukon", "CET", "Chile/Continental", "Chile/EasterIsland", "CST6CDT", "Cuba", "EET", "Egypt", "Eire", "EST", "EST5EDT", "Etc/GMT", "Etc/GMT0", "Etc/GMT-12", "Etc/GMT-11", "Etc/GMT-10", "Etc/GMT-9", "Etc/GMT-8", "Etc/GMT-7", "Etc/GMT-6", "Etc/GMT-5", "Etc/GMT-4", "Etc/GMT-3", "Etc/GMT-2", "Etc/GMT-1", "Etc/GMT-0", "Etc/GMT+0", "Etc/GMT+1", "Etc/GMT+2", "Etc/GMT+3", "Etc/GMT+4", "Etc/GMT+5", "Etc/GMT+6", "Etc/GMT+7", "Etc/GMT+8", "Etc/GMT+9", "Etc/GMT+10", "Etc/GMT+11", "Etc/GMT+12", "Etc/GMT-13", "Etc/GMT-14", "Etc/Greenwich", "Etc/UCT", "Etc/Universal", "Etc/UTC", "Etc/Zulu", "Europe/Amsterdam", "Europe/Andorra", "Europe/Athens", "Europe/Belfast", "Europe/Belgrade", "Europe/Berlin", "Europe/Bratislava", "Europe/Brussels", "Europe/Bucharest", "Europe/Budapest", "Europe/Busingen", "Europe/Chisinau", "Europe/Copenhagen", "Europe/Dublin", "Europe/Gibraltar", "Europe/Guernsey", "Europe/Helsinki", "Europe/Isle_of_Man", "Europe/Istanbul", "Europe/Jersey", "Europe/Kaliningrad", "Europe/Kiev", "Europe/Lisbon", "Europe/Ljubljana", "Europe/London", "Europe/Luxembourg", "Europe/Madrid", "Europe/Malta", "Europe/Mariehamn", "Europe/Minsk", "Europe/Monaco", "Europe/Moscow", "Europe/Nicosia", "Europe/Oslo", "Europe/Paris", "Europe/Podgorica", "Europe/Prague", "Europe/Riga", "Europe/Rome", "Europe/Samara", "Europe/San_Marino", "Europe/Sarajevo", "Europe/Simferopol", "Europe/Skopje", "Europe/Sofia", "Europe/Stockholm", "Europe/Tallinn", "Europe/Tirane", "Europe/Tiraspol", "Europe/Uzhgorod", "Europe/Vaduz", "Europe/Vatican", "Europe/Vienna", "Europe/Vilnius", "Europe/Volgograd", "Europe/Warsaw", "Europe/Zagreb", "Europe/Zaporozhye", "Europe/Zurich", "Factory", "GB", "GB-Eire", "GMT", "GMT0", "GMT-0", "GMT+0", "Greenwich", "Hongkong", "HST", "Iceland", "Indian/Antananarivo", "Indian/Chagos", "Indian/Christmas", "Indian/Cocos", "Indian/Comoro", "Indian/Kerguelen", "Indian/Mahe", "Indian/Maldives", "Indian/Mauritius", "Indian/Mayotte", "Indian/Reunion", "Iran", "Israel", "Jamaica", "Japan", "Kwajalein", "Libya", "MET", "Mexico/BajaNorte", "Mexico/BajaSur", "Mexico/General", "MST", "MST7MDT", "Navajo", "NZ", "NZ-CHAT", "Pacific/Apia", "Pacific/Auckland", "Pacific/Bougainville", "Pacific/Chatham", "Pacific/Chuuk", "Pacific/Easter", "Pacific/Efate", "Pacific/Enderbury", "Pacific/Fakaofo", "Pacific/Fiji", "Pacific/Funafuti", "Pacific/Galapagos", "Pacific/Gambier", "Pacific/Guadalcanal", "Pacific/Guam", "Pacific/Honolulu", "Pacific/Johnston", "Pacific/Kiritimati", "Pacific/Kosrae", "Pacific/Kwajalein", "Pacific/Majuro", "Pacific/Marquesas", "Pacific/Midway", "Pacific/Nauru", "Pacific/Niue", "Pacific/Norfolk", "Pacific/Noumea", "Pacific/Pago_Pago", "Pacific/Palau", "Pacific/Pitcairn", "Pacific/Pohnpei", "Pacific/Ponape", "Pacific/Port_Moresby", "Pacific/Rarotonga", "Pacific/Saipan", "Pacific/Samoa", "Pacific/Tahiti", "Pacific/Tarawa", "Pacific/Tongatapu", "Pacific/Truk", "Pacific/Wake", "Pacific/Wallis", "Pacific/Yap", "Poland", "Portugal", "PRC", "PST8PDT", "ROC", "ROK", "Singapore", "Turkey", "UCT", "Universal", "US/Alaska", "US/Aleutian", "US/Arizona", "US/Central", "US/Eastern", "US/East-Indiana", "US/Hawaii", "US/Indiana-Starke", "US/Michigan", "US/Mountain", "US/Pacific", "US/Pacific-New", "US/Samoa", "UTC", "WET", "W-SU", "Zulu"
            ],
            "Default": "Europe/Berlin",
            "Description": "AWS region's timezone",
            "Type": "String"
        }
	},
    "Conditions" : {
		"CreateEndpoints" : {"Fn::Equals" : [{"Ref": "PublicIP"}, "false"]},
		"CreateS3Endpoint": {"Fn::Equals" : [{"Ref": "CreateS3Endpoint"}, "true"]},
		"CreateKMSEndpoint": {"Fn::Equals" : [{"Ref": "CreateKMSEndpoint"}, "true"]},
		"PublicIP" : {"Fn::Equals" : [{"Ref": "PublicIP"}, "true"]},
		"CreateS3Bucket" : {"Fn::Equals" : [{"Ref": "CreateS3Bucket"}, "true"]}
    },
	"Resources": {	
        "InstanceProfile": {
           "Type": "AWS::IAM::InstanceProfile",
           "Properties": {
              "Path": "/",
              "Roles": [ { "Ref": "EC2Role" } ]
           }
        },
		"EC2Role": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": ["ec2.amazonaws.com"]
						},
						"Action": ["sts:AssumeRole"]
					}]
				},
				"Path": "/",
				"Policies": [{
					"PolicyName": "EC2Policy",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [
                        {
                            "Effect":"Allow",
                            "Action":"s3:*",
                            "Resource": { "Fn::If" : [ "CreateS3Bucket", {"Fn::Join": ["", ["arn:aws:s3:::", {"Ref":"S3Bucket"},"*"]]}, "arn:aws:s3:::dummybucket"]}
                        }]
					}
				}]
			}
		},
        "MasterKey" : {
            "Type" : "AWS::KMS::Key",
            "Properties" : {
                "Description" : "Encrypting user data",
				"Tags": [
					{
					"Key": "exa:project",
					"Value": { "Ref" : "ProjectTag" }
					},
					{
					"Key": "exa:owner",
					"Value": { "Ref" : "OwnerTag" }
					}						
				],
									
                "KeyPolicy" : {
                "Version": "2012-10-17",
                "Id": "User-data-key",
                "Statement": [
                  {
                      "Sid": "Allow administration of the key",
                      "Effect": "Allow",
                      "Principal": { "AWS": { "Fn::Join": ["", ["arn:aws:iam::", { "Ref" : "AWS::AccountId" },":root"]]}},
                      "Action": [
                          "kms:*"
                      ],
                      "Resource": "*"
                    },
                    {
                    "Sid": "Allow administration of the key",
                    "Effect": "Allow",
                    "Principal": { "AWS": { "Fn::Join": ["", ["arn:aws:iam::", { "Ref" : "AWS::AccountId" },":role/", { "Ref": "EC2Role" }]]}},
                    "Action": [
                        "kms:Decrypt", "kms:Encrypt"
                    ],
                    "Resource": "*"
                    },
                    {
                    "Sid": "Allow use of the key",
                    "Effect": "Allow",
                    "Principal": { "AWS": { "Fn::Join": ["", ["arn:aws:iam::", { "Ref" : "AWS::AccountId" },":role/", { "Ref": "HelperLambdaRole" }]]}},
                    "Action": [
                        "kms:Encrypt"
                    ], 
                    "Resource": "*"
                    }    
                ]
                }
            }
        },
        "EncryptCredentialsFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Handler": "index.handler",
				"Tags": [
					{
					"Key": "exa:project",
					"Value": { "Ref" : "ProjectTag" }
					},
					{
					"Key": "exa:owner",
					"Value": { "Ref" : "OwnerTag" }
					}						
				],
									
                "Role": {
                    "Fn::GetAtt": [
                        "HelperLambdaRole",
                        "Arn"
                    ]
                },
                "Code": {
					"ZipFile": { "Fn::Join": ["", [
                            "'use strict';",
							"const response = require('cfn-response');",
                            "const AWS = require('aws-sdk');",
                            "const kms = new AWS.KMS();",
                            "exports.handler = function(event, context) {",
                            "   kms.encrypt({KeyId:'", { "Ref" : "MasterKey" },"',Plaintext: event.ResourceProperties.DBPassword}, function(err, data1) {",
                            "      if (err) { console.log(err, err.stack); }",
                            "      kms.encrypt({KeyId:'", { "Ref" : "MasterKey" },"',Plaintext: event.ResourceProperties.ExasolPassword}, function(err, data2) {",
                            "         if (err) { console.log(err, err.stack); }",
                            "         return response.send(event, context, response.SUCCESS, { DBPassword: data1.CiphertextBlob.toString('base64'), ExasolPassword: data2.CiphertextBlob.toString('base64') });",
                            "      });",
                            "  });",
                            "};"
							]
						]
					}
                },
				"Runtime": "nodejs12.x",
				"Timeout": "300"
            }
        },
        "EncryptCredentials": {
            "Type": "Custom::EncryptCredentials",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "EncryptCredentialsFunction",
                        "Arn"
                    ]
                },
                "DBPassword": { "Ref": "DBPassword" },
				"ExasolPassword": { "Ref": "ExasolPassword"}
            }
        },
        "GetSubnetCidrFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Handler": "index.handler",
				"Tags": [
					{
					"Key": "exa:project",
					"Value": { "Ref" : "ProjectTag" }
					},
					{
					"Key": "exa:owner",
					"Value": { "Ref" : "OwnerTag" }
					}						
				],
								
                "Role": {
                    "Fn::GetAtt": [
                        "HelperLambdaRole",
                        "Arn"
                    ]
                },
                "Code": {
					"ZipFile": { "Fn::Join": ["", [
                            "'use strict';",
							"const response = require('cfn-response');",
                            "const AWS = require('aws-sdk');",
                            "const ec2 = new AWS.EC2();",
                            "exports.handler = function(event, context) {",
                            "   let params = {",
                            "       DryRun: false,",
                            "       SubnetIds: [event.ResourceProperties.SubnetId]",
                            "   };",
                            "   ec2.describeSubnets(params, function(err, data) {",
                            "       if (err) { console.log(err, err.stack);",
                            "       } else {",
							"           ec2.describeRouteTables({Filters: [{Name: 'association.subnet-id', Values: [event.ResourceProperties.SubnetId]}]}, function(err1, data1) {",
							"              try {",
							"                    return response.send(event, context, response.SUCCESS, { CidrBlock: data.Subnets[0].CidrBlock, VpcId: data.Subnets[0].VpcId, RouteTableId: data1.RouteTables[0].RouteTableId });",
							"              } catch(e) {",
							"                 ec2.describeRouteTables({Filters: [{Name: 'vpc-id', Values: [data.Subnets[0].VpcId]}]}, function(err2, data2) {",	
							"                    return response.send(event, context, response.SUCCESS, { CidrBlock: data.Subnets[0].CidrBlock, VpcId: data.Subnets[0].VpcId, RouteTableId: data2.RouteTables[0].RouteTableId });",
							"                 });",											
							"              }",
							"           });",
							"       }",
                            "   });",
                            "};"
							]
						]
					}
                },
				"Runtime": "nodejs12.x",
				"Timeout": "300"
            }
        },
        "GetSubnetCidr": {
            "Type": "Custom::GetSubnetCidr",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "GetSubnetCidrFunction",
                        "Arn"
                    ]
                },
                "SubnetId": {"Ref":"SubnetId"}
            }
        },
        "CreateEC2InstanceLambdaRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": ["lambda.amazonaws.com"]
						},
						"Action": ["sts:AssumeRole"]
					}]
				},
				"Path": "/",
				"ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],
				"Policies": [{
					"PolicyName": "LambdaPolicy",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [
                        {
							"Effect": "Allow",
							"Action": ["ec2:Describe*"],
                            "Resource": "*"
						},                        
						{
							"Effect": "Allow",
							"Action": ["ec2:RunInstances", "ec2:TerminateInstances", "ec2:CreateTags", "cloudformation:DescribeStacks"],
                            "Resource": [
                                { "Fn::Join": ["", ["arn:aws:ec2:", { "Ref" : "AWS::Region" },":", { "Ref" : "AWS::AccountId" },":subnet/", {"Ref":"SubnetId"}]]},
                                { "Fn::Join": ["", ["arn:aws:ec2:", { "Ref" : "AWS::Region" },":", { "Ref" : "AWS::AccountId" },":network-interface/*"]]},
                                { "Fn::Join": ["", ["arn:aws:ec2:", { "Ref" : "AWS::Region" },":", { "Ref" : "AWS::AccountId" },":instance/*"]]},
                                { "Fn::Join": ["", ["arn:aws:ec2:", { "Ref" : "AWS::Region" },":", { "Ref" : "AWS::AccountId" },":volume/*"]]},
                                { "Fn::Join": ["", ["arn:aws:ec2:", { "Ref" : "AWS::Region" },"::image/", {"Ref":"ImageId"}]]},
                                { "Fn::Join": ["", ["arn:aws:ec2:", { "Ref" : "AWS::Region" },":", { "Ref" : "AWS::AccountId" },":key-pair/", { "Ref": "KeyName" }]]},
                                { "Fn::Join": ["", ["arn:aws:ec2:", { "Ref" : "AWS::Region" },":", { "Ref" : "AWS::AccountId" },":security-group/", {"Ref": "DBSecurityGroup"}]]},
								{ "Fn::Join": ["", ["arn:aws:cloudformation:", { "Ref" : "AWS::Region" },":", { "Ref" : "AWS::AccountId" },":stack/", {"Ref": "AWS::StackName"}, "/*"]]}
                            ]
						},
                        {
                            "Effect":"Allow",
                            "Action":["iam:PassRole"],
                            "Resource": [{ "Fn::Join": ["", ["arn:aws:iam::", { "Ref" : "AWS::AccountId" },":role/", { "Ref": "AWS::StackName" }, "-*"]]}]
                        }]
					}
				}]
			}
		},
        "HelperLambdaRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": ["lambda.amazonaws.com"]
						},
						"Action": ["sts:AssumeRole"]
					}]
				},
				"Path": "/",
				"ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],
				"Policies": [{
					"PolicyName": "LambdaPolicy",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [
                        {
							"Effect": "Allow",
							"Action": ["ec2:Describe*"],
                            "Resource": "*"
						},
                        {
							"Effect": "Allow",
							"Action": ["ec2:AuthorizeSecurityGroupIngress"],
                            "Resource": { "Fn::Join": ["", ["arn:aws:ec2:", { "Ref" : "AWS::Region" },":", { "Ref" : "AWS::AccountId" },":security-group/*"]]}
						}]
					}
				}]
			}
		},
		"DBServer": {
			"Type": "Custom::EC2Instances",
			"Properties": {
				"ServiceToken": {
					"Fn::GetAtt": ["CreateEC2InstanceLambda", "Arn"]
				},
                "ImageId":{"Ref":"ImageId"},
				"BlockDeviceMappings": [],
				"InstanceType": "",
				"IamInstanceProfile": {
                    "Name": { "Ref": "InstanceProfile" }
                },
				"KeyName": {
					"Ref": "KeyName"
				},
                "NetworkInterfaces": [{
                    "AssociatePublicIpAddress": {"Ref": "PublicIP"},
                    "Groups": [{"Ref": "DBSecurityGroup"}],
                    "DeviceIndex": 0,
                    "SubnetId":{"Ref":"SubnetId"}
                }],
				"TagSpecifications": [
				{
				  	"ResourceType": "instance",
					"Tags": [
						{
						"Key": "Name",
						"Value": { "Fn::Join": ["", [{ "Ref": "AWS::StackName" },"-db_node"]]}
                        }
						,{
						"Key": "exa:project",
						"Value": { "Ref" : "ProjectTag" }
						},
						{
						"Key": "exa:owner",
						"Value": { "Ref" : "OwnerTag" }
						}	
														
					]
				}],
				"UserData": {
					"Fn::Base64": {
						"Fn::Base64": {
							"Fn::Join": [
								"", [
									"mkdir -p /var/lib/exawolke/\n",
									"LICENSE='",
									{
										"Ref" : "License"
									},
									"'\n",
                                    "if ! [[ -z ${LICENSE//} ]]; then mv /usr/opt/EXAWolke/etc/exasolution.lic /usr/opt/EXAWolke/etc/exasolution.lic_backup; echo $LICENSE > /usr/opt/EXAWolke/etc/exasolution.lic; fi\n",
									"ln -sf /var/lib/exawolke/cluster.conf\n",
									"cat <<-EOF > /var/lib/exawolke/cluster.conf\n",
									"NODES=''\n",
									"PASSWORD_DB='",
									{
										"Fn::GetAtt": ["EncryptCredentials", "DBPassword"]
									},
									"'\n",
									"PASSWORD='",
									{
										"Fn::GetAtt": ["EncryptCredentials", "ExasolPassword"]
									},
									"'\n",
                                    "KMS='True'\n",   
									"DB_NAME='",
									{
                                        "Ref": "DBSystemName"
									},
									"'\n",									
                                    "DATA_EBS_ENCRYPTED='",
									{
                                        "Ref": "DBEBSEncryption"
									},
									"'\n",
								    "TIMEZONE='",
									 {
                                        "Ref":"Timezone"
									 },
									 "'\n",
                                    "DNS_SERVER_1='",
									 {
                                        "Ref":"DNSServer"
									 },
									 "'\n",
                                    "NTP_SERVER_1='",
									 {
                                        "Ref":"NTPServer"
									 },
									 "'\n",
									"DB_RESTORE_BACKUP_SOURCE='",
									{
										"Fn::If" : [ "CreateS3Bucket", {"Fn::Join": ["", ["https://", {"Ref":"S3Bucket"},".s3.", { "Ref" : "AWS::Region" },".amazonaws.com"]]}, ""]     
									},
									"'\n",
									"KERNEL_PARAMETERS=''\n",
									"NETWORK_RANGE='",
									{
                                    "Fn::GetAtt": ["GetSubnetCidr", "CidrBlock"]
                                    
									},
									"'\n",
									"COS_NETWORK='",
									{
                                    "Fn::GetAtt": ["GetSubnetCidr", "CidrBlock"]
                                    
									},
									"'\n",
									"COS_NETWORK_OFFSET='0'\n",
									"TESTS=''\n",
									"TAG='",
                                    { 
                                        "Ref": "AWS::StackName" 
                                    },
                                    "'\n",
									"EOF",
									"\n",
									"\n"
								]
							]
						}
					}
				}
			}
		},
		"CreateEC2InstanceLambda": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Handler": "index.handler",
				"Tags": [
					{
					"Key": "exa:project",
					"Value": { "Ref" : "ProjectTag" }
					},
					{
					"Key": "exa:owner",
					"Value": { "Ref" : "OwnerTag" }
					}						
				],
								
				"Role": {
					"Fn::GetAtt": [
						"CreateEC2InstanceLambdaRole",
						"Arn"
					]
				},
				"Code": {
					"ZipFile": { "Fn::Join": ["", [
                            "'use strict';",
							"const response = require('cfn-response');",
							"const AWS = require('aws-sdk');",

                            "const regexIP = /\\b((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b/;",
                            "function toInt(ip) {return ip.split('.').map((octet, index, array) => {return parseInt(octet) * Math.pow(256, (array.length - index - 1));}).reduce((prev, curr) => {return prev + curr;});}",
                            "function toIP(value) {const result = /\\d+/.exec(value);value = result[0];return [(value>>24)&0xff, (value>>16)&0xff, (value>>8)&0xff, value&0xff].join('.');}",


							"exports.handler = function(e, context) {",

								"let physicalId = e.PhysicalResourceId || 'none';",

								"function success(data) {",
									"return response.send(e, context, response.SUCCESS, data, physicalId);",
								"}",
								"function failed(e) {",
									"return response.send(e, context, response.FAILED, e, physicalId);",
								"}",

								"let ec2 = new AWS.EC2();",
								"let cf = new AWS.CloudFormation();",
								"let allTags = [];",
								"let cfTags = [];",
								"cf.describeStacks({StackName: '",{"Ref": "AWS::StackName"},"'}, function(err, data) {",
								"if (err){",
								"console.log('Error get cf tags: ' + err + ', stack: ' + err.stack);",
								"return failed({Error: 'Err get cf tags: ' + err + ', stack: ' + err.stack })}",
								"else {",
								"cfTags = data['Stacks'][0]['Tags'];",
								"allTags = e.ResourceProperties.TagSpecifications[0].Tags.concat(data['Stacks'][0]['Tags']);",
								"console.log('All tags: ', allTags);",
								"}});",
                                "let instanceIds = [];",
								"e.ResourceProperties.MaxCount=1;",
								"e.ResourceProperties.MinCount=1;",
                                "e.ResourceProperties.NetworkInterfaces[0].AssociatePublicIpAddress = (e.ResourceProperties.NetworkInterfaces[0].AssociatePublicIpAddress == 'true');",
								"delete e.ResourceProperties.ServiceToken;",

								"e.ResourceProperties.InstanceType='", {"Ref": "DatabaseNodeInstanceType"},"'.split('--')[0];",


                                "for (let i=1; i <= ", { "Ref": "BlockDeviceCount" },"; i++) {",
									"e.ResourceProperties.BlockDeviceMappings.push({'DeviceName': '/dev/xvd'+String.fromCharCode(i+97), 'Ebs': { 'Encrypted': ", { "Ref": "DBEBSEncryption" },", 'VolumeSize': ", { "Ref": "BlockDeviceVolumeSize" },", 'VolumeType': 'gp2'}});",
								"}",

                                "if (e.RequestType == 'Create') {",

                                    "let promises = [];",
                                    "promises.push(ec2.runInstances(e.ResourceProperties).promise());",

                                    "Promise.all(promises).then((data) => {",
										"var instanceIds = data.map(x => x['Instances'][0]['InstanceId']);",
										"setTimeout(function(){",
											"ec2.describeVolumes({Filters: [{Name: 'attachment.instance-id',  Values: instanceIds}]}, function(err, data) {",
												"let promisevols = [];",
												"data['Volumes'].forEach(y => {",
													"promisevols.push(ec2.createTags({Resources: [y ['VolumeId']], Tags: allTags}).promise());",											
												"});",
												"if (cfTags.length > 0) {ec2.createTags({Resources: instanceIds, Tags: cfTags}).promise();}",
												"physicalId = instanceIds.join(':');",
												"Promise.all(promisevols).then((data) => {",
													"success({Instances: instanceIds});",
												"}).catch((e)=> failed(e));",												
											"});",
										"}, 3000);",
                                    "}).catch((e)=> failed(e));",

                                "} else if (e.RequestType == 'Delete') {",

                                    "if (physicalId == 'none') {",
                                        "return success({});",
                                    "}",

                                    "let deleteParams = {InstanceIds: physicalId.split(':')};",
                                    "ec2.terminateInstances(deleteParams).promise().then((data)=>",
                                        "ec2.waitFor('instanceTerminated', deleteParams).promise()",
                                    ").then((data)=>success({})",
                                    ").catch((e)=>failed(e));",

                                "} else {",
                                    "return failed({Error: 'In-place updates not supported.'});",
                                "}",
							"};"
							]
						]
					}
				},
				"Runtime": "nodejs12.x",
				"Timeout": "300"
			}
		},
        "SecurityGroupConfigFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Handler": "index.handler",
				"Tags": [
					{
					"Key": "exa:project",
					"Value": { "Ref" : "ProjectTag" }
					},
					{
					"Key": "exa:owner",
					"Value": { "Ref" : "OwnerTag" }
					}						
				],
								
                "Role": {
                    "Fn::GetAtt": [
                        "HelperLambdaRole",
                        "Arn"
                    ]
                },
                "Code": {
					"ZipFile": { "Fn::Join": ["", [
								"'use strict';",
								"const response = require('cfn-response');",
								"const AWS = require('aws-sdk');",
								"const ec2 = new AWS.EC2();",
								"exports.handler = function(event, context) {",
								"   let ipRanges = event.ResourceProperties.SecurityGroupAccess.map(x => {",
								"      let tmp = {CidrIp: x};",
								"      return tmp;});",
									
								"   let ipPermissions = [];",
								"   event.ResourceProperties.Openports.forEach(x => {",
								"      let ports = x.split('-');",
								"      ipPermissions.push({FromPort: ports[0], IpProtocol: 'tcp', IpRanges: ipRanges, ToPort: (ports.length == 1) ? ports[0] : ports[1]});",
								"   });",
								"   var params = {GroupId: event.ResourceProperties.SecurityGroupId, IpPermissions: ipPermissions};",
								"   ec2.authorizeSecurityGroupIngress(params, function(err, data) {",
								"      return response.send(event, context, response.SUCCESS, {err, data});",
								"   });",
								"}"
							]
						]
					}
                },
				"Runtime": "nodejs12.x",
				"Timeout": "300"
            }
        },
        "SecurityGroupConfig": {
            "Type": "Custom::SecurityGroupConfig",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "SecurityGroupConfigFunction",
                        "Arn"
                    ]
                },
                "SecurityGroupId": {"Ref": "DBSecurityGroup"},
                "SecurityGroupAccess": {"Ref": "SecurityGroupAccess" },
				"Openports": {"Ref": "OpenPorts"}
            }
        },		
		"DBSecurityGroup": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"GroupDescription": "Security group for Exasol DB",
				"Tags": [
					{
					"Key": "exa:project",
					"Value": { "Ref" : "ProjectTag" }
					},
					{
					"Key": "exa:owner",
					"Value": { "Ref" : "OwnerTag" }
					}						
				],
				"VpcId": {
                    "Fn::GetAtt": ["GetSubnetCidr", "VpcId"]
                    
				}
			}
		},
		"DBSecurityGroupSelfRule": {
			"Properties": {
				"GroupId": {
					"Fn::GetAtt": [
						"DBSecurityGroup",
						"GroupId"
					]
				},
				"IpProtocol": "-1",
				"SourceSecurityGroupId": {
					"Fn::GetAtt": [
						"DBSecurityGroup",
						"GroupId"
					]
				}
			},
			"Type": "AWS::EC2::SecurityGroupIngress"
		},
        "S3Bucket": {
            "Type" : "AWS::S3::Bucket",
			"Condition" : "CreateS3Bucket",
            "Properties" : {
                "Tags" : [
					{
						"Key":"Name",
						"Value":{ "Ref": "AWS::StackName" }
					}
					,{
						"Key": "exa:project",
						"Value": { "Ref" : "ProjectTag" }
					}
					,{
						"Key": "exa:owner",
						"Value": { "Ref" : "OwnerTag" }
					}						
										
				],
				"BucketEncryption": {
					"ServerSideEncryptionConfiguration": [
						{
						"ServerSideEncryptionByDefault": {
						"SSEAlgorithm": "AES256"
						}
					}]
				}					
            }
        },
		"KMSEndpoint" : {
			"Type" : "AWS::EC2::VPCEndpoint",
			"Condition" : "CreateKMSEndpoint",
			"Properties" : {
				"SubnetIds" : [ {"Ref":"SubnetId"} ],
				"SecurityGroupIds": [{"Ref": "DBSecurityGroup"}],
				"ServiceName" : { "Fn::Join": [ "", [ "com.amazonaws.", { "Ref": "AWS::Region" }, ".kms" ] ] },
				"VpcId" : {"Fn::GetAtt": ["GetSubnetCidr", "VpcId"]},
				"VpcEndpointType": "Interface",
				"PrivateDnsEnabled": true
			}
		},
		"S3Endpoint" : {
			"Type" : "AWS::EC2::VPCEndpoint",
			"Condition" : "CreateS3Endpoint",
			"Properties" : {
				"ServiceName" : { "Fn::Join": [ "", [ "com.amazonaws.", { "Ref": "AWS::Region" }, ".s3" ] ] },
								"RouteTableIds" : [{"Fn::GetAtt": ["GetSubnetCidr", "RouteTableId"]}],
				"VpcId" : {"Fn::GetAtt": ["GetSubnetCidr", "VpcId"]}
			}
		}			
	}
}

